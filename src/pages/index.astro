---
import ReportLayout from "../layouts/ReportLayout.astro";
import { loadQuery } from "../sanity/lib/load-query";
import { urlForImage } from "../sanity/lib/url-for-image";

interface ReportCard {
  title: string;
  excerpt?: string;
  publishedAt?: string;
  featuredImage?: any;
  category?: string;
  slug?: { current: string } | string;
}

const categoryLabels: Record<string, string> = {
  "agribusiness-food": "Agribusiness & Food Value Chain",
  "distribution-logistics": "Distribution & Logistics",
  "industrial-infrastructure": "Industrial & Infrastructure Services",
  manufacturing: "Manufacturing",
  "pet-industry": "Pet Industry",
  "professional-services": "Professional Services",
  "software-it": "Software & IT Services",
  "wellness-health": "Wellness & Health Services",
};

const { data: reports = [] } = await loadQuery<ReportCard[]>({
  query: `*[_type == "report"] | order(publishedAt desc){
    title,
    excerpt,
    publishedAt,
    category,
    "slug": slug.current,
    featuredImage
  }`,
});
---

<ReportLayout
  title="SDR Reports - Industry Insights"
  description="Sanity-powered reports, analysis, and M&A insights across SDR Ventures focus sectors."
  publishDate={new Date().toISOString()}
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="flex items-center justify-between flex-wrap gap-4 mb-8">
      <div>
        <h1 class="text-4xl font-bold text-white mb-2">Industry Reports</h1>
        <p class="text-lg text-slate-300">
          Curated research and transaction insights from the team at SDR Ventures.
        </p>
      </div>
    </div>

    {reports.length === 0 ? (
      <div class="bg-[#0f1f3a]/50 border border-dashed border-white/20 rounded-2xl p-10 text-center text-slate-300">
        <p>No reports found in Sanity yet. Publish a report in the Studio to see it here.</p>
      </div>
    ) : (
      <div class="grid gap-6 md:grid-cols-2">
        {reports.map((report) => {
          const slug = typeof report.slug === "string" ? report.slug : report.slug?.current;
          if (!slug) return null;
          const imageUrl = report.featuredImage
            ? urlForImage(report.featuredImage).width(900).height(520).fit("crop").url()
            : null;
          const published = report.publishedAt
            ? new Date(report.publishedAt).toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
              })
            : "Draft";
          const category = report.category ? categoryLabels[report.category] ?? report.category : "Uncategorized";

          return (
            <a
              href={`/reports/${slug}`}
              class="group block bg-[#0f1f3a]/60 border border-white/10 rounded-2xl overflow-hidden hover:border-brand/50 transition"
            >
              {imageUrl && (
                <div class="overflow-hidden">
                  <img
                    src={imageUrl}
                    alt={report.title}
                    class="h-52 w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-6 space-y-3">
                <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-slate-400">
                  <span class="bg-brand/20 text-brand px-2 py-1 rounded-full border border-brand/30">
                    {category}
                  </span>
                  <span aria-hidden="true">â€¢</span>
                  <span>{published}</span>
                </div>
                <h2 class="text-2xl font-bold text-white group-hover:text-brand transition-colors">
                  {report.title}
                </h2>
                {report.excerpt && <p class="text-slate-300 text-sm leading-relaxed">{report.excerpt}</p>}
                <div class="text-brand flex items-center gap-1 text-sm font-semibold">
                  Read report
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </div>
            </a>
          );
        })}
      </div>
    )}
  </div>
</ReportLayout>
