---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

interface Props {
  src: string | ImageMetadata;
  alt: string;
  caption: string;
  title?: string;
  bgColor?: 'white' | 'default';
  lightboxSrc?: string;
  lightboxAlt?: string;
  lightbox?: boolean;
}

const {
  src,
  alt,
  caption,
  title,
  bgColor = 'default',
  lightboxSrc,
  lightboxAlt,
  lightbox = true,
} = Astro.props;

const backgrounds = {
  white: 'bg-white border-slate-200',
  default: 'bg-[#0f1f3a]/50 border-white/10',
};

const innerBackgrounds = {
  white: 'bg-slate-50',
  default: 'bg-[#0a1628]/50',
};

// Check if src is an optimized image import (ImageMetadata) or a legacy string path
const isOptimizedImage = typeof src !== 'string';
const enableLightbox = lightbox && Boolean(lightboxSrc);
---

<figure class={`${backgrounds[bgColor]} rounded-2xl p-6 my-8 border`}>
  {title && (
    <h3 class={`text-base font-semibold mb-4 ${bgColor === 'white' ? 'text-slate-900' : 'text-white'}`}>
      {title}
  </h3>
  )}
  <div class={`${innerBackgrounds[bgColor]} rounded-xl p-8 mb-4`}>
    {enableLightbox ? (
      <button
        type="button"
        class="w-full text-left group cursor-zoom-in"
        data-lightbox-src={lightboxSrc}
        data-lightbox-alt={lightboxAlt || alt}
        aria-label={`Open chart in full-screen: ${lightboxAlt || alt}`}
      >
        {isOptimizedImage ? (
          <Image 
            src={src as ImageMetadata}
            alt={alt}
            class="w-full h-auto transition-transform duration-300 group-hover:scale-[1.01]"
            loading="lazy"
            widths={[400, 600, 800, 1000, 1200]}
            sizes="(max-width: 768px) 100vw, (max-width: 1024px) 80vw, 60vw"
          />
        ) : (
          <img 
            src={src as string}
            alt={alt}
            class="w-full h-auto transition-transform duration-300 group-hover:scale-[1.01]"
            loading="lazy"
          />
        )}
      </button>
    ) : (
      <div class="w-full">
      {isOptimizedImage ? (
        <Image 
          src={src as ImageMetadata}
          alt={alt}
          class="w-full h-auto transition-transform duration-300 group-hover:scale-[1.01]"
          loading="lazy"
          widths={[400, 600, 800, 1000, 1200]}
          sizes="(max-width: 768px) 100vw, (max-width: 1024px) 80vw, 60vw"
        />
      ) : (
        <img 
          src={src as string}
          alt={alt}
          class="w-full h-auto transition-transform duration-300 group-hover:scale-[1.01]"
          loading="lazy"
        />
      )}
      </div>
    )}
  </div>
  <figcaption class={`text-sm text-center ${bgColor === 'white' ? 'text-slate-600' : 'text-slate-400'}`}>
    {caption}
  </figcaption>
</figure>
